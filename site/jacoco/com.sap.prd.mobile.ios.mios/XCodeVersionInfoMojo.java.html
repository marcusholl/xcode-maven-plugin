<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>XCodeVersionInfoMojo.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Xcode Maven Plugin</a> &gt; <a href="index.html" class="el_package">com.sap.prd.mobile.ios.mios</a> &gt; <span class="el_source">XCodeVersionInfoMojo.java</span></div><h1>XCodeVersionInfoMojo.java</h1><pre class="source lang-java linenums">/*
 * #%L
 * xcode-maven-plugin
 * %%
 * Copyright (C) 2012 SAP AG
 * %%
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */
package com.sap.prd.mobile.ios.mios;

import static java.lang.String.format;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import javax.xml.bind.JAXBException;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.TransformerFactoryConfigurationError;
import javax.xml.transform.stream.StreamResult;
import javax.xml.transform.stream.StreamSource;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
import org.apache.maven.artifact.Artifact;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.project.MavenProjectHelper;
import org.sonatype.aether.RepositorySystem;
import org.sonatype.aether.RepositorySystemSession;
import org.sonatype.aether.repository.RemoteRepository;
import org.xml.sax.SAXException;

import com.sap.prd.mobile.ios.mios.CodeSignManager.ExecResult;
import com.sap.prd.mobile.ios.mios.CodeSignManager.ExecutionResultVerificationException;
import com.sap.prd.mobile.ios.mios.versioninfo.v_1_2_2.Dependency;

/**
 * Generates a &amp;lt;artifact-id&amp;gt;-&amp;lt;version&amp;gt;-version.xml for reproducibility reasons. This
 * versions.xml contains information about the scm location and revision of the built project and
 * all its dependencies. Expects a sync.info file in the root folder of the project as input.
 * 
 * 
 * The sync.info file is a property file. If used with perforce it must contain the following entries: 
 * &lt;code&gt;
 * &lt;ul&gt;
 *   &lt;li&gt; type=perforce
 *   &lt;li&gt; port=&amp;lt;The url of the perforce server&amp;gt;
 *   &lt;li&gt; depotpath=&amp;lt;The path synced on the perforce server&amp;gt;
 *   &lt;li&gt; changelist=&amp;lt;The changelist of the change that is being built&amp;gt
 * &lt;/ul&gt;
 * &lt;/code&gt;
 *
 * 
 * If used with git it must contain the following entries:
 * 
 * &lt;code&gt;
 * &lt;ul&gt;
 *   &lt;li&gt; type=git
 *   &lt;li&gt; repo=&amp;lt;The git repository&amp;gt;
 *   &lt;li&gt; commitId=&amp;lt;The commitId of the change that is being built&amp;gt;
 * &lt;/ul&gt;
 * &lt;/code&gt;
 * 
 * For git based projects the sync.info file can be created with the following code snipped executed before the xcode-maven-plugin is triggered.
 * 
 * &lt;pre&gt;
 * echo &quot;type=git&quot; &gt; sync.info
 * echo &quot;repo=scm:git:$(git remote -v |awk '/fetch/ {print $2;}')&quot; &gt;&gt; sync.info
 * echo &quot;commitId=$(git rev-parse HEAD)&quot; &gt;&gt; sync.info
 * &lt;/pre&gt;
 * 
 * @goal attach-version-info
 * @requiresDependencyResolution
 */
<span class="fc" id="L96">public class XCodeVersionInfoMojo extends BuildContextAwareMojo</span>
{

  /**
   * 
   * @parameter default-value=&quot;${session}&quot;
   * @required
   * @readonly
   */
  protected MavenSession mavenSession;

  /**
   * The entry point to Aether, i.e. the component doing all the work.
   * 
   * @component
   */
  protected RepositorySystem repoSystem;

  /**
   * The current repository/network configuration of Maven.
   * 
   * @parameter default-value=&quot;${repositorySystemSession}&quot;
   * @readonly
   */
  protected RepositorySystemSession repoSession;

  /**
   * The project's remote repositories to use for the resolution of project dependencies.
   * 
   * @parameter default-value=&quot;${project.remoteProjectRepositories}&quot;
   * @readonly
   */
  protected List&lt;RemoteRepository&gt; projectRepos;

  /**
   * @component
   */
  private MavenProjectHelper projectHelper;

  /**
   * @parameter expression=&quot;${sync.info.file}&quot; default-value=&quot;sync.info&quot;
   */
  private String syncInfo;

  /**
   * If &lt;code&gt;true&lt;/code&gt; the build fails if it does not find a sync.info file in the root directory
   * 
   * @parameter expression=&quot;${xcode.failOnMissingSyncInfo}&quot; default-value=&quot;false&quot;
   */
  private boolean failOnMissingSyncInfo;

  /**
   * If &lt;code&gt;true&lt;/code&gt; confidential information is removed from artifacts to be released.
   * 
   * @parameter expression=&quot;${xcode.hideConfidentialInformation}&quot; default-value=&quot;true&quot;
   */
  private boolean hideConfidentialInformation;

  @Override
  public void execute() throws MojoExecutionException, MojoFailureException
  {

<span class="nc" id="L158">    final File syncInfoFile = new File(mavenSession.getExecutionRootDirectory(), syncInfo);</span>

<span class="nc bnc" id="L160" title="All 2 branches missed.">    if (!syncInfoFile.exists()) {</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">      if (failOnMissingSyncInfo)</span>
      {
<span class="nc" id="L164">        throw new MojoExecutionException(&quot;Sync info file '&quot; + syncInfoFile.getAbsolutePath()</span>
              + &quot;' not found. Please configure your SCM plugin accordingly.&quot;);
      }

<span class="nc" id="L168">      getLog().info(&quot;The optional sync info file '&quot; + syncInfoFile.getAbsolutePath()</span>
            + &quot;' not found. Cannot attach versions.xml to build results.&quot;);
<span class="nc" id="L170">      return;</span>
    }

<span class="nc" id="L173">    getLog().info(&quot;Sync info file found: '&quot; + syncInfoFile.getAbsolutePath() + &quot;'. Creating versions.xml file.&quot;);</span>

<span class="nc" id="L175">    final File versionsXmlFile = new File(project.getBuild().getDirectory(), &quot;versions.xml&quot;);</span>

<span class="nc" id="L177">    FileOutputStream os = null;</span>

    try {
<span class="nc" id="L180">      os = new FileOutputStream(versionsXmlFile);</span>

<span class="nc" id="L182">      new VersionInfoXmlManager().createVersionInfoFile(project.getGroupId(), project.getArtifactId(),</span>
            project.getVersion(), syncInfoFile, getDependencies(), os);

    }
<span class="nc" id="L186">    catch (IOException e) {</span>
<span class="nc" id="L187">      throw new MojoExecutionException(e.getMessage(), e);</span>
    }
    finally {
<span class="nc" id="L190">      IOUtils.closeQuietly(os);</span>
<span class="nc" id="L191">    }</span>

<span class="nc" id="L193">    final File versionsPlistFile = new File(project.getBuild().getDirectory(), &quot;versions.plist&quot;);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">    if (versionsPlistFile.exists()) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">      if(!versionsPlistFile.delete())</span>
      {
<span class="nc" id="L197">        throw new IllegalStateException(String.format(&quot;Cannot delete already existing plist file (%s)&quot;, versionsPlistFile));</span>
      }
    }
    try {
<span class="nc" id="L201">      new VersionInfoPListManager().createVersionInfoPlistFile(project.getGroupId(), project.getArtifactId(),</span>
            project.getVersion(), syncInfoFile, getDependencies(), versionsPlistFile, hideConfidentialInformation);
    }
<span class="nc" id="L204">    catch (IOException e) {</span>
<span class="nc" id="L205">      throw new MojoExecutionException(e.getMessage(), e);</span>
<span class="nc" id="L206">    }</span>

    try {
<span class="nc bnc" id="L209" title="All 2 branches missed.">      if (PackagingType.getByMavenType(packaging) == PackagingType.APP)</span>
      {
        try
        {
<span class="nc" id="L213">          copyVersionsFilesAndSign();</span>
        }
<span class="nc" id="L215">        catch (IOException e) {</span>
<span class="nc" id="L216">          throw new MojoExecutionException(e.getMessage(), e);</span>
        }
<span class="nc" id="L218">        catch (ExecutionResultVerificationException e) {</span>
<span class="nc" id="L219">          throw new MojoExecutionException(e.getMessage(), e);</span>
        }
<span class="nc" id="L221">        catch (XCodeException e) {</span>
<span class="nc" id="L222">          throw new MojoExecutionException(e.getMessage(), e);</span>
<span class="nc" id="L223">        }</span>
      }
    }
<span class="nc" id="L226">    catch (PackagingType.UnknownPackagingTypeException ex) {</span>
<span class="nc" id="L227">      getLog().warn(&quot;Unknown packaing type detected.&quot;, ex);</span>

<span class="nc" id="L229">    }</span>

<span class="nc" id="L231">    projectHelper.attachArtifact(project, &quot;xml&quot;, &quot;versions&quot;, versionsXmlFile);</span>
<span class="nc" id="L232">    getLog().info(&quot;versions.xml '&quot; + versionsXmlFile + &quot; attached as additional artifact.&quot;);</span>

<span class="nc" id="L234">  }</span>

  private void copyVersionsFilesAndSign() throws IOException, ExecutionResultVerificationException, XCodeException,
        MojoExecutionException
  {
<span class="nc bnc" id="L239" title="All 2 branches missed.">    for (final String configuration : getConfigurations())</span>
    {
<span class="nc bnc" id="L241" title="All 2 branches missed.">      for (final String sdk : getSDKs())</span>
      {
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (sdk.startsWith(&quot;iphoneos&quot;))</span>
        {
<span class="nc" id="L245">          File versionsXmlInBuild = new File(project.getBuild().getDirectory(), &quot;versions.xml&quot;);</span>
<span class="nc" id="L246">          File versionsPListInBuild = new File(project.getBuild().getDirectory(), &quot;versions.plist&quot;);</span>

<span class="nc" id="L248">          File rootDir = XCodeBuildLayout.getAppFolder(getXCodeCompileDirectory(), configuration, sdk);</span>

<span class="nc" id="L250">          String productName = getProductName(configuration, sdk);</span>
<span class="nc" id="L251">          File appFolder = new File(rootDir, productName + &quot;.app&quot;);</span>
<span class="nc" id="L252">          File versionsXmlInApp = new File(appFolder, &quot;versions.xml&quot;);</span>
<span class="nc" id="L253">          File versionsPListInApp = new File(appFolder, &quot;versions.plist&quot;);</span>

<span class="nc" id="L255">          CodeSignManager.verify(appFolder);</span>
<span class="nc" id="L256">          final ExecResult originalCodesignEntitlementsInfo = CodeSignManager</span>
            .getCodesignEntitlementsInformation(appFolder);
<span class="nc" id="L258">          final ExecResult originalSecurityCMSMessageInfo = CodeSignManager.getSecurityCMSInformation(appFolder);</span>

          try {
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (hideConfidentialInformation) {</span>
<span class="nc" id="L262">              transformVersionsXml(versionsXmlInBuild, versionsXmlInApp);</span>
            }
            else {
<span class="nc" id="L265">              FileUtils.copyFile(versionsXmlInBuild, versionsXmlInApp);</span>
            }
          }
<span class="nc" id="L268">          catch (Exception e) {</span>
<span class="nc" id="L269">            throw new MojoExecutionException(&quot;Could not transform versions.xml: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L270">          }</span>

<span class="nc" id="L272">          getLog().info(&quot;Versions.xml file copied from: '&quot; + versionsXmlInBuild + &quot; ' to ' &quot; + versionsXmlInApp);</span>
<span class="nc" id="L273">          FileUtils.copyFile(versionsPListInBuild, versionsPListInApp);</span>
<span class="nc" id="L274">          getLog().info(&quot;Versions.plist file copied from: '&quot; + versionsPListInBuild + &quot; ' to ' &quot; + versionsPListInApp);</span>

<span class="nc" id="L276">          sign(rootDir, configuration, sdk);</span>

<span class="nc" id="L278">          final ExecResult resignedCodesignEntitlementsInfo = CodeSignManager</span>
            .getCodesignEntitlementsInformation(appFolder);
<span class="nc" id="L280">          final ExecResult resignedSecurityCMSMessageInfo = CodeSignManager.getSecurityCMSInformation(appFolder);</span>
<span class="nc" id="L281">          CodeSignManager.verify(appFolder);</span>
<span class="nc" id="L282">          CodeSignManager.verify(originalCodesignEntitlementsInfo, resignedCodesignEntitlementsInfo);</span>
<span class="nc" id="L283">          CodeSignManager.verify(originalSecurityCMSMessageInfo, resignedSecurityCMSMessageInfo);</span>
        }
<span class="nc" id="L285">      }</span>
<span class="nc" id="L286">    }</span>
<span class="nc" id="L287">  }</span>

  void transformVersionsXml(File versionsXmlInBuild, File versionsXmlInApp)
        throws ParserConfigurationException, SAXException, IOException, TransformerFactoryConfigurationError,
        TransformerException, XCodeException
  {
<span class="nc" id="L293">    final InputStream transformerRule = getClass().getClassLoader().getResourceAsStream(</span>
          &quot;versionInfoCensorTransformation.xml&quot;);

<span class="nc bnc" id="L296" title="All 2 branches missed.">    if (transformerRule == null)</span>
    {
<span class="nc" id="L298">      throw new XCodeException(&quot;Could not read transformer rule.&quot;);</span>
    }

    try
    {
<span class="nc" id="L303">      final Transformer transformer = TransformerFactory.newInstance().newTransformer(</span>
            new StreamSource(transformerRule));
<span class="nc" id="L305">      transformer.setOutputProperty(OutputKeys.STANDALONE, &quot;yes&quot;);</span>
<span class="nc" id="L306">      transformer.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);</span>
<span class="nc" id="L307">      transformer.setOutputProperty(&quot;{http://xml.apache.org/xslt}indent-amount&quot;, &quot;2&quot;);</span>
<span class="nc" id="L308">      transformer.transform(new StreamSource(versionsXmlInBuild), new StreamResult(versionsXmlInApp));</span>
    }
    finally {
<span class="nc" id="L311">      IOUtils.closeQuietly(transformerRule);</span>
<span class="nc" id="L312">    }</span>
<span class="nc" id="L313">  }</span>

  private void sign(File rootDir, String configuration, String sdk) throws IOException, XCodeException
  {
<span class="nc" id="L317">    String csi = EffectiveBuildSettings.getBuildSetting(</span>
          getXCodeContext(XCodeContext.SourceCodeLocation.WORKING_COPY, configuration, sdk),
          EffectiveBuildSettings.CODE_SIGN_IDENTITY);
<span class="nc" id="L320">    File appFolder = new File(EffectiveBuildSettings.getBuildSetting(</span>
          getXCodeContext(XCodeContext.SourceCodeLocation.WORKING_COPY, configuration, sdk),
          EffectiveBuildSettings.CODESIGNING_FOLDER_PATH));
<span class="nc" id="L323">    CodeSignManager.sign(csi, appFolder, true);</span>
<span class="nc" id="L324">  }</span>

  private List&lt;Dependency&gt; getDependencies() throws IOException
  {

<span class="nc" id="L329">    List&lt;Dependency&gt; result = new ArrayList&lt;Dependency&gt;();</span>

    for (@SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc bnc" id="L332" title="All 2 branches missed.">    final Iterator it = project.getDependencyArtifacts().iterator(); it.hasNext();) {</span>

<span class="nc" id="L334">      final Artifact mainArtifact = (Artifact) it.next();</span>

      try {

<span class="nc" id="L338">        org.sonatype.aether.artifact.Artifact sideArtifact = new XCodeDownloadManager(projectRepos, repoSystem,</span>
              repoSession).resolveSideArtifact(mainArtifact, &quot;versions&quot;, &quot;xml&quot;);

<span class="nc" id="L341">        getLog().info(&quot;Version information retrieved for artifact: &quot; + mainArtifact);</span>

<span class="nc" id="L343">        addParsedVersionsXmlDependency(result, sideArtifact);</span>

      }
<span class="nc" id="L346">      catch (SideArtifactNotFoundException e) {</span>
<span class="nc" id="L347">        getLog().warn(&quot;Could not retrieve version information for artifact:&quot; + mainArtifact);</span>
<span class="nc" id="L348">      }</span>
<span class="nc" id="L349">    }</span>
<span class="nc" id="L350">    return result;</span>
  }

  void addParsedVersionsXmlDependency(List&lt;Dependency&gt; result,
        org.sonatype.aether.artifact.Artifact sideArtifact) throws IOException
  {
    try {
<span class="fc" id="L357">      result.add(VersionInfoXmlManager.parseDependency(sideArtifact.getFile()));</span>
    }
<span class="fc" id="L359">    catch (SAXException e) {</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">      getLog().warn(format(</span>
            &quot;Version file '%s' for artifact '%s' contains invalid content (Non parsable XML). Ignoring this file.&quot;,
            (sideArtifact.getFile() != null ? sideArtifact.getFile() : &quot;&lt;n/a&gt;&quot;), sideArtifact));
    }
<span class="fc" id="L364">    catch (JAXBException e) {</span>
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">      getLog().warn(format(</span>
            &quot;Version file '%s' for artifact '%s' contains invalid content (Scheme violation). Ignoring this file.&quot;,
            (sideArtifact.getFile() != null ? sideArtifact.getFile() : &quot;&lt;n/a&gt;&quot;), sideArtifact));
<span class="fc" id="L368">    }</span>
<span class="fc" id="L369">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>
