<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>AbstractXCodeMojo.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Xcode Maven Plugin</a> &gt; <a href="index.html" class="el_package">com.sap.prd.mobile.ios.mios</a> &gt; <span class="el_source">AbstractXCodeMojo.java</span></div><h1>AbstractXCodeMojo.java</h1><pre class="source lang-java linenums">/*
 * #%L
 * xcode-maven-plugin
 * %%
 * Copyright (C) 2012 SAP AG
 * %%
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */
package com.sap.prd.mobile.ios.mios;

import java.io.File;
import java.util.Collections;
import java.util.HashSet;
import java.util.Set;
import java.util.logging.LogManager;

import org.apache.maven.plugin.AbstractMojo;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.project.MavenProject;

/**
 * Base class for Xcode specific mojos
 * 
 */
<span class="fc" id="L36">public abstract class AbstractXCodeMojo extends AbstractMojo</span>
{
  //
  // This variable here ensures that a reference to the logger is kept.
  // According to the API doc of the java.util.logging framework it is required
  // to keep a reference. Otherwise it might happen that the logger is garbage
  // collected. This in turn must not happen since the logger keeps a
  // reference to the maven logger that could not be restored. This variable
  // should not be accessed. Instead use the LogManager to get the instance.
  //
<span class="fc" id="L46">  private static XCodePluginLogger logger = null;</span>
  
  static {

<span class="pc bpc" id="L50" title="1 of 2 branches missed.">    if(null == LogManager.getLogManager().getLogger(XCodePluginLogger.getLoggerName())) {</span>

<span class="nc" id="L52">      logger = new XCodePluginLogger();</span>
<span class="nc" id="L53">      LogManager.getLogManager().addLogger(logger);</span>
<span class="nc" id="L54">      logger.finest(String.format(&quot;XCode plugin logger has been created: %s&quot;, logger.getName()));</span>
    }
<span class="fc" id="L56">  }</span>
  
  /**
   * The original Xcode sources located in the &lt;code&gt;src/xcode&lt;/code&gt; directory stay untouched
   * during the whole Maven build. However, as we might have to modify the info.plist or the project
   * itself we copy the whole Xcode source directory during the build into another &quot;checkout&quot;
   * directory that by default named &lt;code&gt;checkout&lt;/code&gt; and located below the Maven build (
   * &lt;code&gt;target&lt;/code&gt;) directory.
   * 
   * @parameter expression=&quot;${xcode.checkoutDirectory}&quot;;
   */
  private File checkoutDirectory;

  /**
   * The xcode directory of the copied sources below the checkout directory.
   * 
   * @parameter expression=&quot;${xcode.compileDirectory}&quot;
   */
  private File xcodeCompileDirectory;

  /**
   * @parameter expression=&quot;${project}&quot;
   * @readonly
   * @required
   */
  protected MavenProject project;

  /**
   * The Xcode configurations that shall be built (e.g. Debug and Release).
   * 
   * If no configuration is provided in the plugin's &lt;code&gt;configuration&lt;/code&gt; section of the
   * &lt;code&gt;pom.xml&lt;/code&gt; it defaults to the values provided in the
   * &lt;code&gt;defaultAppConfigurations&lt;/code&gt; or &lt;code&gt;defaultLibConfigurations&lt;/code&gt; parameters
   * 
   * @parameter
   */
  private Set&lt;String&gt; configurations;

  /**
   * @parameter expression=&quot;${project.packaging}&quot;
   * @readonly
   * @required
   */
  protected String packaging;

  /**
   * Explicit lists of sdks (iphoneos,iphonesimulator) the Xcode project shall be built for.
   * 
   * If no configuration is provided in the plugin's &lt;code&gt;configuration&lt;/code&gt; section of the
   * &lt;code&gt;pom.xml&lt;/code&gt; it defaults to the values provided in the &lt;code&gt;defaultAppSdks&lt;/code&gt; or
   * &lt;code&gt;defaultLibSdks&lt;/code&gt; parameters
   * 
   * @parameter
   */
  private Set&lt;String&gt; sdks;

  /**
   * Comma separated list of the default Xcode build configurations that should be built for apps
   * (in contrast to libraries). These values only apply if no &quot;configurations&quot; are explicitly
   * provided in the POM.
   * 
   * @parameter expression=&quot;${xcode.app.defaultConfigurations}&quot; default-value=&quot;Release,Debug&quot;
   * @since 1.2.0
   * 
   */
  private String defaultAppConfigurations;

  /**
   * Comma separated list of the default Xcode build configurations that should be built for
   * libraries (in contrast to apps). These values only apply if no &quot;configurations&quot; are explicitly
   * provided in the POM.
   * 
   * @parameter expression=&quot;${xcode.lib.defaultConfigurations}&quot; default-value=&quot;Release,Debug&quot;
   * @since 1.2.0
   * 
   */
  private String defaultLibConfigurations;

  /**
   * Comma separated list of the default Xcode SDKs that should be used for apps (in contrast to
   * libs). These values only apply if no &quot;sdks&quot; are explicitly provided in the POM.
   * 
   * @parameter expression=&quot;${xcode.app.defaultSdks}&quot; default-value=&quot;iphoneos,iphonesimulator&quot;
   * @since 1.2.0
   * 
   */
  private String defaultAppSdks;

  /**
   * Comma separated list of the default Xcode SDKs that should be used for libraries (in contrast
   * to apps). These values only apply if no &quot;sdks&quot; are explicitly provided in the POM.
   * 
   * @parameter expression=&quot;${xcode.lib.defaultSdks}&quot; default-value=&quot;iphoneos,iphonesimulator&quot;
   * @since 1.2.0
   * 
   */
  private String defaultLibSdks;

  protected Set&lt;String&gt; getSDKs()
  {
<span class="nc bnc" id="L156" title="All 4 branches missed.">    if (sdks == null || sdks.isEmpty()) {</span>

      try {

<span class="nc" id="L160">        PackagingType packagingType = PackagingType.getByMavenType(packaging);</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (packagingType == PackagingType.APP) {</span>

<span class="nc" id="L164">          getLog().info(</span>
                &quot;No SDKs in POM set. Using default configurations for applications: &quot; + defaultAppSdks);
<span class="nc" id="L166">          return commaSeparatedStringToSet(defaultAppSdks);</span>
        }
<span class="nc bnc" id="L168" title="All 4 branches missed.">        else if (packagingType == PackagingType.LIB || packagingType == PackagingType.FRAMEWORK) {</span>
<span class="nc" id="L169">          getLog().info(</span>
                &quot;No SDKs in POM set. Using default configurations for libraries: &quot; + defaultLibSdks);
<span class="nc" id="L171">          return commaSeparatedStringToSet(defaultLibSdks);</span>
        }
      }
<span class="nc" id="L174">      catch (PackagingType.UnknownPackagingTypeException e) {</span>
<span class="nc" id="L175">        getLog().info(&quot;Unknown PackagingType found.&quot;, e);</span>
<span class="nc" id="L176">        return Collections.emptySet();</span>
<span class="nc" id="L177">      }</span>
    }
<span class="nc" id="L179">    getLog().info(&quot;SDKs have been explicitly set in POM: &quot; + sdks);</span>
<span class="nc" id="L180">    return sdks;</span>
  }

  protected Set&lt;String&gt; getConfigurations()
  {
<span class="nc bnc" id="L185" title="All 4 branches missed.">    if (configurations == null || configurations.isEmpty()) {</span>

      try {
<span class="nc" id="L188">        PackagingType packagingType = PackagingType.getByMavenType(packaging);</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (packagingType == PackagingType.APP) {</span>
<span class="nc" id="L191">          getLog().info(</span>
                &quot;No configurations in POM set. Using default configurations for applications: &quot;
                      + defaultAppConfigurations);
<span class="nc" id="L194">          return commaSeparatedStringToSet(defaultAppConfigurations);</span>
        }
<span class="nc bnc" id="L196" title="All 4 branches missed.">        else if (packagingType == PackagingType.LIB || packagingType == PackagingType.FRAMEWORK) {</span>
<span class="nc" id="L197">          getLog()</span>
            .info(
                  &quot;No configurations in POM set. Using default configurations for libraries: &quot;
                        + defaultLibConfigurations);
<span class="nc" id="L201">          return commaSeparatedStringToSet(defaultLibConfigurations);</span>
        }
      }
<span class="nc" id="L204">      catch (PackagingType.UnknownPackagingTypeException e) {</span>
<span class="nc" id="L205">        getLog().info(&quot;Unknown PackagingType found.&quot;, e);</span>
<span class="nc" id="L206">        return Collections.emptySet();</span>
<span class="nc" id="L207">      }</span>
    }
<span class="nc" id="L209">    getLog().info(&quot;Configurations have been explicitly set in POM: &quot; + configurations);</span>
<span class="nc" id="L210">    return configurations;</span>
  }

  private Set&lt;String&gt; commaSeparatedStringToSet(String commaSeparetedValues)
  {
<span class="nc" id="L215">    Set&lt;String&gt; values = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L216">    String[] valueArray = commaSeparetedValues.split(&quot;,&quot;);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">    for (String value : valueArray) {</span>
<span class="nc" id="L218">      value = value.trim();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">      if (!value.isEmpty()) {</span>
<span class="nc" id="L220">        values.add(value);</span>
      }
    }
<span class="nc" id="L223">    return Collections.unmodifiableSet(values);</span>
  }

  protected File getCheckoutDirectory()
  {
<span class="nc" id="L228">    return checkoutDirectory;</span>
  }

  /**
   * The xcode directory of the copied sources below the checkout directory.
   */
  protected File getXCodeCompileDirectory()
  {
<span class="nc" id="L236">    return xcodeCompileDirectory;</span>
  }

  /**
   * 
   * @return the &lt;code&gt;src/xcode&lt;/code&gt; directory
   */
  protected File getXCodeSourceDirectory()
  {
<span class="nc" id="L245">    return new File(project.getBuild().getSourceDirectory());</span>
  }

  protected String getFixedProductName(final String productName)
  {
<span class="nc" id="L250">    return productName.trim().replaceAll(&quot; &quot;, &quot;&quot;);</span>
  }

  protected File getXCodeProjectFile()
  {
<span class="nc" id="L255">    return new File(getXCodeCompileDirectory(), project.getArtifactId() + &quot;.xcodeproj/project.pbxproj&quot;);</span>
  }

  /**
   * Calls a shell script in order to zip a folder. We have to call a shell script as Java cannot
   * zip symbolic links.
   * 
   * @param rootDir
   *          the directory where the zip command shall be executed
   * @param zipSubFolder
   *          the subfolder to be zipped
   * @param zipFileName
   *          the name of the zipFile (will be located in the rootDir)
   * @param archiveFolder
   *          an optional folder name if the zipSubFolder folder shall be placed inside the zip into
   *          a parent folder
   * @return the zip file
   * @throws MojoExecutionException
   */
  protected File zipSubfolder(File rootDir, String zipSubFolder, String zipFileName, String archiveFolder)
        throws MojoExecutionException
  {
<span class="nc" id="L277">    int resultCode = 0;</span>

    try {

<span class="nc" id="L281">      File scriptDirectory = new File(project.getBuild().getDirectory(), &quot;scripts&quot;).getCanonicalFile();</span>
<span class="nc" id="L282">      scriptDirectory.deleteOnExit();</span>

<span class="nc bnc" id="L284" title="All 2 branches missed.">      if (archiveFolder != null)</span>
      {
<span class="nc" id="L286">        resultCode = ScriptRunner.copyAndExecuteScript(System.out, &quot;/com/sap/prd/mobile/ios/mios/zip-subfolder.sh&quot;,</span>
              scriptDirectory, rootDir.getCanonicalPath(), zipSubFolder, zipFileName, archiveFolder);
      }
      else
      {
<span class="nc" id="L291">        resultCode = ScriptRunner.copyAndExecuteScript(System.out, &quot;/com/sap/prd/mobile/ios/mios/zip-subfolder.sh&quot;,</span>
              scriptDirectory, rootDir.getCanonicalPath(), zipSubFolder, zipFileName);
      }
    }
<span class="nc" id="L295">    catch (Exception ex) {</span>
<span class="nc" id="L296">      throw new MojoExecutionException(&quot;Cannot create zip file &quot; + zipFileName + &quot;. Check log for details.&quot;, ex);</span>
<span class="nc" id="L297">    }</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">    if (resultCode != 0) {</span>
<span class="nc" id="L299">      throw new MojoExecutionException(&quot;Cannot create zip file &quot; + zipFileName + &quot;. Check log for details.&quot;);</span>
    }
<span class="nc" id="L301">    getLog().info(&quot;Zip file '&quot; + zipFileName + &quot;' created.&quot;);</span>
<span class="nc" id="L302">    return new File(rootDir, zipFileName);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>
