<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>XCodeVerificationCheckMojo.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Xcode Maven Plugin</a> &gt; <a href="index.html" class="el_package">com.sap.prd.mobile.ios.mios</a> &gt; <span class="el_source">XCodeVerificationCheckMojo.java</span></div><h1>XCodeVerificationCheckMojo.java</h1><pre class="source lang-java linenums">/*
 * #%L
 * xcode-maven-plugin
 * %%
 * Copyright (C) 2012 SAP AG
 * %%
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */
package com.sap.prd.mobile.ios.mios;

import static java.lang.String.format;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.PrintStream;
import java.io.Reader;
import java.io.StringReader;
import java.io.UnsupportedEncodingException;
import java.net.MalformedURLException;
import java.net.URI;
import java.net.URL;
import java.nio.charset.Charset;
import java.security.KeyManagementException;
import java.security.NoSuchAlgorithmException;
import java.security.cert.CertificateException;
import java.security.cert.X509Certificate;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Properties;
import java.util.Set;
import java.util.logging.LogManager;
import java.util.logging.Logger;

import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLException;
import javax.net.ssl.SSLSession;
import javax.net.ssl.SSLSocket;
import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang.CharSet;
import org.apache.commons.lang.StringUtils;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.conn.ClientConnectionManager;
import org.apache.http.conn.scheme.Scheme;
import org.apache.http.conn.scheme.SchemeRegistry;
import org.apache.http.conn.ssl.SSLSocketFactory;
import org.apache.http.conn.ssl.X509HostnameVerifier;
import org.apache.http.impl.client.BasicResponseHandler;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.codehaus.plexus.classworlds.ClassWorld;
import org.codehaus.plexus.classworlds.realm.ClassRealm;
import org.codehaus.plexus.classworlds.realm.DuplicateRealmException;
import org.sonatype.aether.RepositorySystem;
import org.sonatype.aether.RepositorySystemSession;
import org.sonatype.aether.collection.DependencyCollectionException;
import org.sonatype.aether.graph.Dependency;
import org.sonatype.aether.repository.RemoteRepository;
import org.sonatype.aether.util.artifact.DefaultArtifact;

import com.sap.prd.mobile.ios.mios.XCodeContext.SourceCodeLocation;
import com.sap.prd.mobile.ios.mios.verificationchecks.v_1_0_0.Check;
import com.sap.prd.mobile.ios.mios.verificationchecks.v_1_0_0.Checks;

/**
 * Provides the possibility to perform verification checks.&lt;br&gt;
 * The check classes and their severities are described in an additional xml document, defined in
 * &lt;code&gt;xcode.verification.checks.definitionFile&lt;/code&gt;.&lt;br&gt;
 * The specific checks have to be implemented in separate projects. These projects define dependency
 * to Xcode Maven Pugin Verification API and must not reference the xcode-maven-plugin project.
 * The Xcode Maven Plugin Verification API project could be found &lt;a href=https://github.com/sap-production/xcode-maven-plugin-verification-api&gt;here&lt;/a&gt;
 * The coordinates of that projects need to be provided on the
 * &lt;code&gt;check&lt;/code&gt; node belonging to the test as attributes &lt;code&gt;groupId&lt;/code&gt;,
 * &lt;code&gt;artifactId&lt;/code&gt; and &lt;code&gt;version&lt;/code&gt;.&lt;br&gt;
 * The classpath for this goal will be extended by the jars found under the specified GAVs. &lt;br&gt;
 * Example checks definition:
 * 
 * &lt;pre&gt;
 * &amp;lt;checks&amp;gt;
 *   &amp;lt;check groupId=&quot;my.group.id&quot; artifactId=&quot;artifactId&quot; version=&quot;1.0.0&quot; severity=&quot;ERROR&quot; class=&quot;com.my.MyVerificationCheck1&quot;/&amp;gt;
 *   &amp;lt;check groupId=&quot;my.group.id&quot; artifactId=&quot;artifactId&quot; version=&quot;1.0.0&quot; severity=&quot;WARNING&quot; class=&quot;com.my.MyVerificationCheck2&quot;/&amp;gt;
 * &amp;lt;/checks&amp;gt;
 * &lt;/pre&gt;
 * 
 * @goal verification-check
 * 
 */
<span class="nc" id="L114">public class XCodeVerificationCheckMojo extends BuildContextAwareMojo</span>
{
  private final static String COLON = &quot;:&quot;, DOUBLE_SLASH = &quot;//&quot;;
<span class="fc" id="L117">  private static final Logger log = LogManager.getLogManager().getLogger(XCodePluginLogger.getLoggerName());</span>

<span class="fc" id="L119">  private enum Protocol</span>
  {

<span class="fc" id="L122">    HTTP() {</span>

      @Override
      Reader getCheckDefinitions(String location) throws IOException
      {
<span class="nc" id="L127">        HttpClient httpClient = new DefaultHttpClient();</span>
<span class="nc" id="L128">        HttpGet get = new HttpGet(getName() + COLON + DOUBLE_SLASH + location);</span>

<span class="nc" id="L130">        String response = httpClient.execute(get, new BasicResponseHandler());</span>
<span class="nc" id="L131">        return new StringReader(response);</span>
      }

    },
<span class="fc" id="L135">    HTTPS() {</span>

      @Override
      Reader getCheckDefinitions(String location) throws IOException
      {
<span class="nc" id="L140">        HttpClient httpClient = new DefaultHttpClient();</span>
        try {
<span class="nc" id="L142">          SSLContext sslcontext = SSLContext.getInstance(&quot;TLS&quot;);</span>
<span class="nc" id="L143">          X509TrustManager trustManager = new X509TrustManager() {</span>

            @Override
            public X509Certificate[] getAcceptedIssuers()
            {
<span class="nc" id="L148">              return null;</span>
            }

            @Override
            public void checkServerTrusted(X509Certificate[] chain, String authType) throws CertificateException
            {
<span class="nc" id="L154">            }</span>

            @Override
            public void checkClientTrusted(X509Certificate[] chain, String authType) throws CertificateException
            {
<span class="nc" id="L159">            }</span>
          };
<span class="nc" id="L161">          X509HostnameVerifier hostNameVerifier = new X509HostnameVerifier() {</span>

            @Override
            public boolean verify(String arg0, SSLSession arg1)
            {
<span class="nc" id="L166">              return true;</span>
            }

            @Override
            public void verify(String host, String[] cns, String[] subjectAlts) throws SSLException
            {
<span class="nc" id="L172">            }</span>

            @Override
            public void verify(String host, X509Certificate cert) throws SSLException
            {
<span class="nc" id="L177">            }</span>

            @Override
            public void verify(String host, SSLSocket ssl) throws IOException
            {
<span class="nc" id="L182">            }</span>
          };

<span class="nc" id="L185">          final int port = new URL(getName() + COLON + DOUBLE_SLASH + location).getPort();</span>
<span class="nc" id="L186">          sslcontext.init(null, new TrustManager[] { trustManager }, null);</span>
<span class="nc" id="L187">          SSLSocketFactory sslSocketFactory = new SSLSocketFactory(sslcontext);</span>
<span class="nc" id="L188">          sslSocketFactory.setHostnameVerifier(hostNameVerifier);</span>
<span class="nc" id="L189">          ClientConnectionManager clientConnectionManager = httpClient.getConnectionManager();</span>
<span class="nc" id="L190">          SchemeRegistry sr = clientConnectionManager.getSchemeRegistry();</span>
<span class="nc" id="L191">          sr.register(new Scheme(getName(), sslSocketFactory, port));</span>
        }
<span class="nc" id="L193">        catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L194">          e.printStackTrace();</span>
        }
<span class="nc" id="L196">        catch (KeyManagementException e) {</span>
          // TODO Auto-generated catch block
<span class="nc" id="L198">          e.printStackTrace();</span>
<span class="nc" id="L199">        }</span>
<span class="nc" id="L200">        HttpGet get = new HttpGet(getName() + COLON + DOUBLE_SLASH + location);</span>

<span class="nc" id="L202">        String response = httpClient.execute(get, new BasicResponseHandler());</span>
<span class="nc" id="L203">        return new StringReader(response);</span>
      }
    },
<span class="fc" id="L206">    FILE() {</span>

      @Override
      Reader getCheckDefinitions(String location) throws IOException
      {
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (location.startsWith(DOUBLE_SLASH)) location = location.substring(DOUBLE_SLASH.length());</span>
<span class="fc" id="L212">        final File f = new File(location);</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (!f.canRead()) {</span>
<span class="nc" id="L214">          throw new IOException(&quot;Cannot read checkDefintionFile '&quot; + f + &quot;'.&quot;);</span>
        }

<span class="fc" id="L217">        return new InputStreamReader((new FileInputStream(f)), &quot;UTF-8&quot;);</span>
      }
    };
    abstract Reader getCheckDefinitions(String location) throws IOException;

    String getName()
    {
<span class="fc" id="L224">      return name().toLowerCase(Locale.ENGLISH);</span>
    }

    static String getProtocols()
    {
<span class="fc" id="L229">      final StringBuilder sb = new StringBuilder(16);</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">      for (Protocol p : Protocol.values()) {</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">        if (sb.length() != 0)</span>
<span class="fc" id="L232">          sb.append(&quot;, &quot;);</span>
<span class="fc" id="L233">        sb.append(p.getName());</span>
      }
<span class="fc" id="L235">      return sb.toString();</span>
    }

    static Protocol getProtocol(String protocol) throws InvalidProtocolException
    {
      try {
<span class="fc" id="L241">        return Protocol.valueOf(protocol.toUpperCase(Locale.ENGLISH));</span>
      }
<span class="fc" id="L243">      catch (final IllegalArgumentException ex) {</span>
<span class="fc" id="L244">        throw new InvalidProtocolException(protocol, ex);</span>
      }
    }
  }

  static class NoProtocolException extends XCodeException
  {

    private static final long serialVersionUID = -5510547403353575108L;

    NoProtocolException(String message, Throwable cause)
    {
<span class="fc" id="L256">      super(message, cause);</span>
<span class="fc" id="L257">    }</span>
  };

  static class InvalidProtocolException extends XCodeException
  {

    private static final long serialVersionUID = -5510547403353515108L;

    InvalidProtocolException(String message, Throwable cause)
    {
<span class="fc" id="L267">      super(message, cause);</span>
<span class="fc" id="L268">    }</span>
  };

  /**
   * The entry point to Aether, i.e. the component doing all the work.
   * 
   * @component
   */
  protected RepositorySystem repoSystem;

  /**
   * The current repository/network configuration of Maven.
   * 
   * @parameter default-value=&quot;${repositorySystemSession}&quot;
   * @readonly
   */
  protected RepositorySystemSession repoSession;

  /**
   * The project's remote repositories to use for the resolution of project dependencies.
   * 
   * @parameter default-value=&quot;${project.remoteProjectRepositories}&quot;
   * @readonly
   */
  protected List&lt;RemoteRepository&gt; projectRepos;

  /**
   * Parameter, which controls the verification goal execution. By default, the verification goal
   * will be skipped.
   * 
   * @parameter expression=&quot;${xcode.verification.checks.skip}&quot; default-value=&quot;true&quot;
   * @since 1.9.3
   */
  private boolean skip;

  /**
   * The location where the check definition file is present. Could be a file on the local file
   * system or a remote located file, accessed via http or https. &lt;br&gt;
   * Examples:
   * &lt;ul&gt;
   * &lt;li&gt;-Dxcode.verification.checks.definitionFile=file:./checkDefinitionFile.xml
   * &lt;li&gt;-Dxcode.verification.checks.definitionFile=http://example.com/checkDefinitionFile.xml
   * &lt;li&gt;-Dxcode.verification.checks.definitionFile=https://example.com/checkDefinitionFile.xml
   * &lt;/ul&gt;
   * 
   * @parameter expression=&quot;${xcode.verification.checks.definitionFile}&quot;
   * @since 1.9.3
   */
  private String checkDefinitionFile;

  @Override
  public void execute() throws MojoExecutionException, MojoFailureException
  {

<span class="nc bnc" id="L322" title="All 2 branches missed.">    if (skip) {</span>

<span class="nc" id="L324">      getLog()</span>
        .info(
              String
                .format(
                      &quot;Verification check goal has been skipped intentionally since parameter 'xcode.verification.checks.skip' is '%s'.&quot;,
                      skip));
<span class="nc" id="L330">      return;</span>
    }

    try {
<span class="nc" id="L334">      PackagingType.getByMavenType(packaging);</span>
    }
<span class="nc" id="L336">    catch (PackagingType.UnknownPackagingTypeException ex)</span>
    {
<span class="nc" id="L338">      getLog().info(</span>
            &quot;Packaging type is &quot; + packaging
                  + &quot;. There is no need to apply verification checks for this packaging type.&quot;);
<span class="nc" id="L341">      return;</span>
<span class="nc" id="L342">    }</span>

    try {

<span class="nc" id="L346">      final Checks checks = getChecks(checkDefinitionFile);</span>

<span class="nc bnc" id="L348" title="All 2 branches missed.">      if (checks.getCheck().isEmpty()) {</span>
<span class="nc" id="L349">        getLog().warn(String.format(&quot;No checks configured in '%s'.&quot;, checkDefinitionFile));</span>
      }

<span class="nc" id="L352">      Map&lt;Check, Exception&gt; failedChecks = new HashMap&lt;Check, Exception&gt;();</span>

<span class="nc bnc" id="L354" title="All 2 branches missed.">      for (Check check : checks.getCheck()) {</span>
        try {
<span class="nc" id="L356">          final ClassRealm verificationCheckRealm = extendClasspath(check);</span>
<span class="nc" id="L357">          final Exception ex = performCheck(verificationCheckRealm, check);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">          if (ex != null)</span>
          {
<span class="nc" id="L360">            failedChecks.put(check, ex);</span>
          }
        }
<span class="nc" id="L363">        catch (DuplicateRealmException ex) {</span>
<span class="nc" id="L364">          throw new MojoExecutionException(ex.getMessage(), ex);</span>
<span class="nc" id="L365">        }</span>
      }

<span class="nc" id="L368">      handleExceptions(failedChecks);</span>

    }
<span class="nc" id="L371">    catch (XCodeException e) {</span>
<span class="nc" id="L372">      throw new MojoExecutionException(e.getMessage(), e);</span>
    }
<span class="nc" id="L374">    catch (IOException e) {</span>
<span class="nc" id="L375">      throw new MojoExecutionException(e.getMessage(), e);</span>
    }
<span class="nc" id="L377">    catch (JAXBException e) {</span>
<span class="nc" id="L378">      throw new MojoExecutionException(e.getMessage(), e);</span>
    }
<span class="nc" id="L380">    catch (DependencyCollectionException e) {</span>
<span class="nc" id="L381">      throw new MojoExecutionException(e.getMessage(), e);</span>
<span class="nc" id="L382">    }</span>
<span class="nc" id="L383">  }</span>

  private Exception performCheck(ClassRealm verificationCheckRealm, final Check checkDesc)
        throws MojoExecutionException
  {

<span class="nc" id="L389">    getLog().info(String.format(&quot;Performing verification check '%s'.&quot;, checkDesc.getClazz()));</span>

<span class="nc bnc" id="L391" title="All 2 branches missed.">    if (getLog().isDebugEnabled()) {</span>

<span class="nc" id="L393">      final Charset defaultCharset = Charset.defaultCharset();</span>
<span class="nc" id="L394">      final ByteArrayOutputStream byteOs = new ByteArrayOutputStream();</span>
      final PrintStream ps;
      try {
<span class="nc" id="L397">       ps = new PrintStream(byteOs, true, defaultCharset.name());</span>
<span class="nc" id="L398">      } catch(UnsupportedEncodingException ex) {</span>
<span class="nc" id="L399">        throw new MojoExecutionException(String.format(&quot;Charset '%s' cannot be found.&quot;, defaultCharset.name()));</span>
<span class="nc" id="L400">      }</span>
      
      try {
<span class="nc" id="L403">        verificationCheckRealm.display(ps);</span>
<span class="nc" id="L404">        ps.close();</span>
<span class="nc" id="L405">        getLog().debug(</span>
              String.format(&quot;Using classloader for loading verification check '%s':%s%s&quot;, checkDesc.getClazz(),
                    System.getProperty(&quot;line.separator&quot;), new String(byteOs.toByteArray(), defaultCharset)));
      }
      finally {
<span class="nc" id="L410">        IOUtils.closeQuietly(ps);</span>
<span class="nc" id="L411">      }</span>
    }

    try {
<span class="nc" id="L415">      final Class&lt;?&gt; verificationCheckClass = Class.forName(checkDesc.getClazz(), true, verificationCheckRealm);</span>

<span class="nc" id="L417">      getLog().debug(</span>
            String.format(&quot;Verification check class %s has been loaded by %s.&quot;, verificationCheckClass.getName(),
                  verificationCheckClass.getClassLoader()));
<span class="nc" id="L420">      getLog().debug(</span>
            String.format(&quot;Verification check super class %s has been loaded by %s.&quot;, verificationCheckClass
              .getSuperclass().getName(), verificationCheckClass.getSuperclass().getClassLoader()));
<span class="nc" id="L423">      getLog().debug(</span>
            String.format(&quot;%s class used by this class (%s) has been loaded by %s.&quot;, VerificationCheck.class.getName(),
                  this.getClass().getName(), VerificationCheck.class.getClassLoader()));

<span class="nc bnc" id="L427" title="All 2 branches missed.">      for (final String configuration : getConfigurations()) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">        for (final String sdk : getSDKs()) {</span>
<span class="nc" id="L429">          getLog().info(</span>
                String.format(&quot;Executing verification check: '%s' for configuration '%s' and sdk '%s'.&quot;,
                      verificationCheckClass.getName(), configuration, sdk));
<span class="nc" id="L432">          final VerificationCheck verificationCheck = (VerificationCheck) verificationCheckClass.newInstance();</span>
<span class="nc" id="L433">          verificationCheck.setXcodeContext(getXCodeContext(SourceCodeLocation.WORKING_COPY, configuration, sdk));</span>
<span class="nc" id="L434">          verificationCheck.setMavenProject(project);</span>
<span class="nc" id="L435">          verificationCheck.setEffectiveBuildSettings(new EffectiveBuildSettings());</span>
          try {
<span class="nc" id="L437">            verificationCheck.check();</span>
          }
<span class="nc" id="L439">          catch (VerificationException ex) {</span>
<span class="nc" id="L440">            return ex;</span>
          }
<span class="nc" id="L442">          catch (RuntimeException ex) {</span>
<span class="nc" id="L443">            return ex;</span>
<span class="nc" id="L444">          }</span>
<span class="nc" id="L445">        }</span>
      }
<span class="nc" id="L447">      return null;</span>
    }
<span class="nc" id="L449">    catch (ClassNotFoundException ex) {</span>
<span class="nc" id="L450">      throw new MojoExecutionException(</span>
            &quot;Could not load verification check '&quot;
                  + checkDesc.getClazz()
                  + &quot;'. May be your classpath has not been properly extended. &quot;
                  +
                  &quot;Provide the GAV of the project containing the check as attributes as part of the check defintion in the check configuration file.&quot;,
            ex);
    }
<span class="nc" id="L458">    catch (NoClassDefFoundError err) {</span>
<span class="nc" id="L459">      getLog().error(String.format(&quot;Could not load verification check '%s'. &quot; +</span>
            &quot;May be your classpath has not been properly extended. &quot; +
            &quot;Additional dependencies need to be declard inside the check definition file: %s&quot;,
            checkDesc.getClazz(), err.getMessage()), err);
<span class="nc" id="L463">      throw err;</span>
    }
<span class="nc" id="L465">    catch (InstantiationException ex) {</span>
<span class="nc" id="L466">      throw new MojoExecutionException(String.format(&quot;Could not instanciate verification check '%s': %s&quot;,</span>
            checkDesc.getClazz(), ex.getMessage()), ex);
    }
<span class="nc" id="L469">    catch (IllegalAccessException ex) {</span>
<span class="nc" id="L470">      throw new MojoExecutionException(String.format(&quot;Could not access verification check '%s': %s&quot;,</span>
            checkDesc.getClazz(), ex.getMessage()), ex);
    }

  }

  private void handleExceptions(Map&lt;Check, Exception&gt; failedChecks)
        throws MojoExecutionException
  {
<span class="nc" id="L479">    boolean mustFailedTheBuild = false;</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">    for (Map.Entry&lt;Check, Exception&gt; entry : failedChecks.entrySet()) {</span>
<span class="nc" id="L481">      handleException(entry.getKey(), entry.getValue());</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">      if (entry.getKey().getSeverity().equalsIgnoreCase(&quot;ERROR&quot;)) {</span>
<span class="nc" id="L483">        mustFailedTheBuild = true;</span>
      }
    }
<span class="nc bnc" id="L486" title="All 2 branches missed.">    if (mustFailedTheBuild) {</span>
<span class="nc" id="L487">      throw new MojoExecutionException(&quot;Verification checks failed. See the log file for details.&quot;);</span>
    }
<span class="nc" id="L489">  }</span>

  private void handleException(Check failedCheck, final Exception e)
  {
    final String message;
<span class="nc bnc" id="L494" title="All 2 branches missed.">    if (e instanceof VerificationException) {</span>
<span class="nc" id="L495">      message = &quot;Verification check '&quot; + failedCheck.getClazz() + &quot; failed. &quot; + e.getMessage();</span>
    }
    else {
<span class="nc" id="L498">      message = &quot;Cannot perform check: &quot; + failedCheck.getClazz() + &quot;. Error during test setup &quot; + e.getMessage();</span>
    }
<span class="nc bnc" id="L500" title="All 2 branches missed.">    if (failedCheck.getSeverity().equalsIgnoreCase(&quot;WARNING&quot;)) {</span>
<span class="nc" id="L501">      getLog().warn(message);</span>
    }
    else {
<span class="nc" id="L504">      getLog().error(message);</span>
    }
<span class="nc" id="L506">  }</span>

  private ClassRealm extendClasspath(Check check) throws XCodeException, DependencyCollectionException,
        DuplicateRealmException, MalformedURLException
  {
<span class="nc" id="L511">    final org.sonatype.aether.artifact.Artifact artifact = parseDependency(check);</span>

<span class="nc" id="L513">    final ClassLoader loader = this.getClass().getClassLoader();</span>

<span class="nc bnc" id="L515" title="All 2 branches missed.">    if (!(loader instanceof ClassRealm)) {</span>

<span class="nc" id="L517">      throw new XCodeException(&quot;Could not add jar to classpath. Class loader '&quot; + loader</span>
            + &quot;' is not an instance of '&quot; + ClassRealm.class.getName() + &quot;'.&quot;);
    }

<span class="nc" id="L521">    final ClassRealm classRealm = (ClassRealm) loader;</span>

<span class="nc bnc" id="L523" title="All 2 branches missed.">    if (artifact == null)</span>
    {
<span class="nc" id="L525">      return classRealm;</span>
    }

<span class="nc" id="L528">    final Set&lt;String&gt; scopes = new HashSet&lt;String&gt;(Arrays.asList(org.apache.maven.artifact.Artifact.SCOPE_COMPILE,</span>
          org.apache.maven.artifact.Artifact.SCOPE_PROVIDED,
          org.apache.maven.artifact.Artifact.SCOPE_RUNTIME,
          org.apache.maven.artifact.Artifact.SCOPE_SYSTEM)); // do not resolve dependencies with scope &quot;test&quot;.

<span class="nc" id="L533">    final XCodeDownloadManager downloadManager = new XCodeDownloadManager(projectRepos, repoSystem, repoSession);</span>

<span class="nc" id="L535">    final Set&lt;org.sonatype.aether.artifact.Artifact&gt; theEmptyOmitsSet = Collections.emptySet();</span>
<span class="nc" id="L536">    final Set&lt;org.sonatype.aether.artifact.Artifact&gt; omits = downloadManager.resolveArtifactWithTransitveDependencies(</span>
          new Dependency(getVerificationAPIGav(), org.apache.maven.artifact.Artifact.SCOPE_COMPILE), scopes,
          theEmptyOmitsSet);

<span class="nc" id="L540">    omits.add(getVerificationAPIGav());</span>

<span class="nc" id="L542">    final Set&lt;org.sonatype.aether.artifact.Artifact&gt; artifacts = downloadManager</span>
      .resolveArtifactWithTransitveDependencies(new Dependency(artifact,
            org.apache.maven.artifact.Artifact.SCOPE_COMPILE), scopes, omits);

<span class="nc" id="L546">    final ClassRealm childClassRealm = classRealm.createChildRealm(getUniqueRealmId(classRealm.getWorld(),</span>
          classRealm.getId() + &quot;-&quot; + check.getClazz()));

<span class="nc" id="L549">    addDependencies(childClassRealm, artifacts);</span>

<span class="nc" id="L551">    return childClassRealm;</span>
  }

  private String getUniqueRealmId(final ClassWorld world, final String realmIdPrefix)
  {
<span class="nc" id="L556">    String uniqueRealmIdCandidate = null;</span>
<span class="nc" id="L557">    int i = 0;</span>
    while (true) {
<span class="nc" id="L559">      uniqueRealmIdCandidate = realmIdPrefix + &quot;-&quot; + i;</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">      if (world.getClassRealm(uniqueRealmIdCandidate) == null)</span>
      {
<span class="nc" id="L562">        return uniqueRealmIdCandidate;</span>
      }
<span class="nc" id="L564">      i++;</span>
    }
  }

  private void addDependencies(final ClassRealm childClassRealm, Set&lt;org.sonatype.aether.artifact.Artifact&gt; artifacts)
        throws MalformedURLException
  {
<span class="nc bnc" id="L571" title="All 2 branches missed.">    for (org.sonatype.aether.artifact.Artifact a : artifacts)</span>
    {
<span class="nc" id="L573">      childClassRealm.addURL(a.getFile().toURI().toURL());</span>
    }
<span class="nc" id="L575">  }</span>

  static org.sonatype.aether.artifact.Artifact parseDependency(final Check check)
        throws XCodeException
  {
<span class="fc" id="L580">    final String groupId = check.getGroupId();</span>
<span class="fc" id="L581">    final String artifactId = check.getArtifactId();</span>
<span class="fc" id="L582">    final String version = check.getVersion();</span>

<span class="pc bpc" id="L584" title="1 of 6 branches missed.">    if (StringUtils.isEmpty(groupId) &amp;&amp; StringUtils.isEmpty(artifactId) &amp;&amp; StringUtils.isEmpty(version)) {</span>
<span class="fc" id="L585">      log.info(</span>
        &quot;No coordinates maintained for check represented by class '&quot; + check.getClazz()
              + &quot;'. Assuming this check is already contained in the classpath.&quot;);
<span class="fc" id="L588">      return null;</span>
    }

<span class="fc bfc" id="L591" title="All 2 branches covered.">    if (StringUtils.isEmpty(groupId))</span>
<span class="fc" id="L592">      throw new XCodeException(String.format(&quot;groupId for check %s is null or emtpy&quot;, check.getClazz()));</span>

<span class="fc bfc" id="L594" title="All 2 branches covered.">    if (StringUtils.isEmpty(artifactId))</span>
<span class="fc" id="L595">      throw new XCodeException(String.format(&quot;artifactId for check %s is null or emtpy&quot;, check.getClazz()));</span>

<span class="fc bfc" id="L597" title="All 2 branches covered.">    if (StringUtils.isEmpty(version))</span>
<span class="fc" id="L598">      throw new XCodeException(String.format(&quot;version for check %s is null or emtpy&quot;, check.getClazz()));</span>

<span class="fc" id="L600">    return new DefaultArtifact(groupId, artifactId, &quot;jar&quot;, version);</span>
  }

  static Checks getChecks(final String checkDefinitionFileLocation) throws XCodeException, IOException, JAXBException
  {
<span class="nc" id="L605">    Reader checkDefinitions = null;</span>

    try {
<span class="nc" id="L608">      checkDefinitions = getChecksDescriptor(checkDefinitionFileLocation);</span>
<span class="nc" id="L609">      return (Checks) JAXBContext.newInstance(Checks.class).createUnmarshaller().unmarshal(checkDefinitions);</span>
    }
    finally {
<span class="nc" id="L612">      IOUtils.closeQuietly(checkDefinitions);</span>
    }
  }

  org.sonatype.aether.artifact.Artifact getVerificationAPIGav() throws XCodeException
  {

<span class="nc" id="L619">    InputStream is = null;</span>

    try {
<span class="nc" id="L622">      is = XCodeVerificationCheckMojo.class.getResourceAsStream(&quot;/misc/project.properties&quot;);</span>

<span class="nc bnc" id="L624" title="All 2 branches missed.">      if (is == null)</span>
      {
<span class="nc" id="L626">        throw new XCodeException(&quot;Cannot get the GAV of the xcode-maven-plugin&quot;);</span>
      }

<span class="nc" id="L629">      Properties props = new Properties();</span>
<span class="nc" id="L630">      props.load(is);</span>

<span class="nc" id="L632">      final String groupId = props.getProperty(&quot;verification.api.groupId&quot;);</span>
<span class="nc" id="L633">      final String artifactId = props.getProperty(&quot;verification.api.artifactId&quot;);</span>
<span class="nc" id="L634">      final String version = props.getProperty(&quot;verification.api.version&quot;);</span>
<span class="nc" id="L635">      return new DefaultArtifact(groupId, artifactId, &quot;jar&quot;, version);</span>
    }
<span class="nc" id="L637">    catch (final IOException ex) {</span>
<span class="nc" id="L638">      throw new XCodeException(&quot;Cannot get the GAV for the verification API&quot;, ex);</span>
    }
    finally {
<span class="nc" id="L641">      IOUtils.closeQuietly(is);</span>
    }
  }

  static Reader getChecksDescriptor(final String checkDefinitionFileLocation) throws XCodeException, IOException
  {
<span class="pc bpc" id="L647" title="2 of 4 branches missed.">    if (checkDefinitionFileLocation == null || checkDefinitionFileLocation.trim().isEmpty()) {</span>
<span class="nc" id="L648">      throw new XCodeException(</span>
            &quot;CheckDefinitionFile was not configured. Cannot perform verification checks. Define check definition file with paramater 'xcode.verification.checks.definitionFile'.&quot;);
    }

<span class="fc" id="L652">    final Location location = Location.getLocation(checkDefinitionFileLocation);</span>

    try {
<span class="fc" id="L655">      Protocol protocol = Protocol.valueOf(location.protocol);</span>
<span class="fc" id="L656">      return protocol.getCheckDefinitions(location.location);</span>
    }
<span class="nc" id="L658">    catch (IllegalArgumentException ex) {</span>
<span class="nc" id="L659">      throw new InvalidProtocolException(format(&quot;Invalid protocol provided: '%s'. Supported values are:'%s'.&quot;,</span>
            location.protocol, Protocol.getProtocols()), ex);
    }
<span class="nc" id="L662">    catch (IOException ex) {</span>
<span class="nc" id="L663">      throw new IOException(format(&quot;Cannot get check definitions from '%s'.&quot;, checkDefinitionFileLocation), ex);</span>
    }
  }

<span class="nc" id="L667">  static class Location</span>
  {
    static Location getLocation(final String locationUriString) throws InvalidProtocolException, NoProtocolException,
          MalformedURLException
    {
      final URL url;

      try {
<span class="fc" id="L675">        url = new URL(locationUriString.trim());</span>
      }
<span class="fc" id="L677">      catch (MalformedURLException ex) {</span>

        //
        // trouble with protocol ???
        //

        try {

<span class="pc bpc" id="L685" title="1 of 2 branches missed.">          if (URI.create(locationUriString).getScheme() == null)</span>
          {
<span class="fc" id="L687">            throw new NoProtocolException(String.format(</span>
                  &quot;Provide a protocol [%s] for parameter 'xcode.verification.checks.definitionFile'&quot;,
                  Protocol.getProtocols()), ex);
          }
        }
<span class="fc" id="L692">        catch (RuntimeException ignore) {</span>
          //
          // in this case we throw already the MalformedUrlExcpetion that indicates a problem with 
          // the URL
          //
<span class="nc" id="L697">        }</span>

<span class="fc" id="L699">        throw ex;</span>

<span class="fc" id="L701">      }</span>

<span class="fc" id="L703">      final Protocol protocol = Protocol.getProtocol(url.getProtocol());</span>
      final String location;
<span class="fc bfc" id="L705" title="All 2 branches covered.">      if (protocol == Protocol.FILE)</span>
      {
<span class="fc" id="L707">        location = url.getPath();</span>
      }
<span class="pc bpc" id="L709" title="1 of 4 branches missed.">      else if (protocol == Protocol.HTTP || protocol == Protocol.HTTPS) {</span>
<span class="fc" id="L710">        location = locationUriString.trim().substring(</span>
              protocol.getName().length() + COLON.length() + DOUBLE_SLASH.length());
      }
      else {
<span class="nc" id="L714">        throw new IllegalStateException(String.format(&quot;Unknown protocol: '%s'.&quot; + url.getProtocol()));</span>
      }
<span class="fc" id="L716">      return new Location(protocol.getName(), location);</span>
    }

    final String protocol;
    final String location;

    public Location(String protocol, String location)
<span class="fc" id="L723">    {</span>
<span class="fc" id="L724">      this.protocol = protocol.toUpperCase(Locale.ENGLISH);</span>
<span class="fc" id="L725">      this.location = location;</span>
<span class="fc" id="L726">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>
